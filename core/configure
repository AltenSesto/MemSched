#!/bin/bash
# Copyright (c) 2014 Shinpei Kato and Mikael Ã…sberg.
# All rights reserved. This program and the accompanying materials are 
# made available under the terms of the GNU Public License v3.0 which 
# accompanies this distribution, and is available at 
# http://www.gnu.org/licenses/gpl.htm

version=$(uname -r)
cpus=$(awk "\$1==\"processor\" {print \$3}" /proc/cpuinfo | wc -l)
pidmax=$(awk "{print \$1}" /proc/sys/kernel/pid_max)

# the following are configurable options.
tasks='64'
balance='0'

# parse options.
for option
do
  case "$option" in
  -*=*) optarg=`echo "$option" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
  *) optarg= ;;
  esac

  case "$option" in
  --tasks=*)
    tasks="$optarg" ;;
  --cpus=*)
    cpus="$optarg" ;;
  --enable-load-balance)
    balance="1" ;;
  esac
done

cat > ./config.h << EOF
#ifndef __CONFIG_H__
#define __CONFIG_H__
/* this is automatically generated by the .configure script. */
#define NR_RT_CPUS $cpus
#define NR_RT_TASKS $tasks
#define PID_MAX $pidmax
#define LOAD_BALANCE_ENABLED $balance
#endif
EOF
cp ./config.h /usr/src/kernels/$(uname -r)/include/resch/  ##nas
echo 'Configuration...'
echo 'Linux kernel version: '$version
echo 'The number of available CPUs:' $cpus
echo 'The maximum number of real-time tasks:' $tasks

if test "$balance" == "1"
then
	echo "Load balance is enabled."
else
	echo "Load balance is disabled."
fi
#corehome=$(pwd)
#echo $corehome
#xcorehome='export COREHOME='"$corehome"
#echo $xcorehome
#echo $xcorehome >> '/etc/bash.bashrc'
